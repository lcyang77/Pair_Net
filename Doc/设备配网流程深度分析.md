● ESP32-C2 IoT设备配网流程深度分析

  基于对代码的全面分析，这个项目实现了一个灵活的双模式配网系统（BLE + AP模式），支持设备首次配网、WiFi连接、云端绑定以及配网重置等完整流程。

  一、项目架构概览

  1.1 核心模块层次结构

  main/
  ├── main.c                     # 主循环入口
  ├── product.c                  # 产品逻辑（按钮、UART、业务逻辑）
  └── gs/                        # Gateway Services 层
      ├── gs_main.c             # GS层初始化
      ├── gs_bind.c             # 配网绑定核心 ⭐
      ├── gs_wifi.c             # WiFi连接管理 ⭐
      ├── gs_mqtt.c             # MQTT通信
      ├── gs_device.c           # 设备信息管理
      └── gs_ota.c              # OTA升级

  components/
  ├── cc/                       # 平台抽象层
  │   ├── port/
  │   │   ├── cc_hal_ble.c     # BLE硬件抽象 ⭐
  │   │   ├── cc_hal_wifi.c    # WiFi硬件抽象
  │   │   ├── cc_hal_kvs.c     # 键值存储抽象
  │   │   └── ...
  └── captive_portal/           # 强制门户实现 ⭐
      └── captive_portal.c

  二、配网流程完整时序

  2.1 系统启动流程

  app_main() [main.c:37]
      ↓
  nvs_flash_init()                      # 初始化NVS存储
      ↓
  cc_hal_sys_init()                     # 系统HAL初始化
  cc_hal_kvs_init()                     # KVS存储初始化
  cc_hal_wifi_init()                    # WiFi HAL初始化
      ↓
  cc_event_init()                       # 事件系统初始化
  cc_timer_init()                       # 定时器系统初始化
      ↓
  gs_init() [gs_main.c:16]              # GS层初始化
      ├── gs_device_init()
      ├── gs_wifi_init()                # 读取WiFi配置 [gs_wifi.c:141]
      ├── gs_bind_init()                # 读取绑定状态 [gs_bind.c:552]
      ├── gs_mqtt_init()
      └── gs_ota_init()
      ↓
  product_init() [product.c:316]        # 产品层初始化
      ├── 读取启动配网模式标志
      ├── 判断设备状态:
      │   ├── 如果有待配网标志 → 启动配网模式
      │   ├── 如果已绑定 → 连接WiFi
      │   └── 否则 → 等待
      ├── __uart_init()                 # 初始化UART通信
      └── __button_init()               # 初始化按钮检测
      ↓
  进入主循环 [main.c:65-77]

  2.2 配网模式触发方式

  方式一：首次启动（未配网）

  product_init() [product.c:318-321]
      ↓
  gs_bind_get_boot_auto_start_cfg_mode() == NULL
      &&
  gs_bind_get_bind_status() == 0
      ↓
  等待手动触发或长按重置

  方式二：长按按钮重置（GPIO9）

  用户长按按钮2秒 [product.c:270-274]
      ↓
  __btn_event_cb1() 检测到 FLEX_BTN_PRESS_LONG_START
      ↓
  gs_bind_reset_bind_status()           # 清除配网状态 [gs_bind.c:530]
      ├── 清除WiFi配置
      ├── 清除MQTT配置
      └── g_bind_status = 0
      ↓
  gs_bind_set_boot_auto_start_cfg_mode(AP|BLE)  # 设置启动配网标志
      ↓
  保存到KVS → "gs_bind_boot"
      ↓
  cc_hal_sys_reboot()                   # 重启设备
      ↓
  启动后自动进入配网模式

  三、配网模式详细实现

  3.1 BLE配网模式

  3.1.1 BLE配网启动流程

  gs_bind_start_cfg_mode(GS_BIND_CFG_MODE_BLE) [gs_bind.c:481]
      ↓
  __ble_bind_cfg_start() [gs_bind.c:378]
      ↓
  cc_hal_ble_init(__ble_recv_cb) [cc_hal_ble.c:272]
      ├── nimble_port_init()             # 初始化NimBLE协议栈
      ├── 注册GATT服务 (UUID: 0xFFE5)
      │   ├── 写特征 (0xFFF3): 接收配网数据
      │   └── 通知特征 (0xFFF4): 发送状态
      └── nimble_port_freertos_init()    # 启动BLE任务
      ↓
  获取BLE MAC地址 [gs_bind.c:383]
      ↓
  生成广播数据 [gs_bind.c:379-388]
      设备名称: "BLE-cloudhome-gs-{MAC后2字节}"
      示例: "BLE-cloudhome-gs-A2B3"
      ↓
  cc_hal_ble_start_advzertising() [cc_hal_ble.c:222]
      ↓
  开始BLE广播，等待手机连接

  3.1.2 BLE配网数据交互

  配网数据格式（JSON）：
  {
      "ssid": "MyWiFi",
      "password": "12345678",
      "token": "device_token_from_cloud"
  }

  接收流程：
  手机通过BLE写入配网数据 (特征0xFFF3)
      ↓
  gatt_svr_chr_access_sec_test() [cc_hal_ble.c:114]
      ↓
  g_ble_recv_cb() → __ble_recv_cb() [gs_bind.c:354]
      ├── 数据分片处理（BLE单包最大20字节）
      ├── 拼接完整JSON
      └── __parse_ble_bind_info() [gs_bind.c:85]
      ↓
  解析JSON并保存 [gs_bind.c:101-123]
      ├── 提取ssid、password、token
      ├── gs_device_save_token(token)    # 保存设备令牌
      ├── gs_wifi_sta_save_config()      # 保存WiFi配置到KVS
      └── 启动500ms定时器准备连接
      ↓
  500ms后执行 __timer_cb_for_wifi_start_connect() [gs_bind.c:47]
      ├── 停止TCP服务器（如有）
      ├── 停止AP模式
      ├── 停止captive portal
      └── gs_wifi_sta_start_connect()     # 开始连接WiFi

  返回流程：
  WiFi连接成功 → 获取IP → MQTT连接成功
      ↓
  __cfg_event_handler() GS_MQTT_EVENT_CONNECTED [gs_bind.c:293]
      ↓
  通过BLE通知特征发送成功消息 [gs_bind.c:308-310]
  {
      "ver": "8.0.0.0",
      "act": "0001",
      "sta": "00",
      "token": "...",
      "seq_no": "..."
  }
      ↓
  cc_hal_ble_send() [cc_hal_ble.c:250]
      ├── 数据分片（每包最大20字节）
      └── ble_gattc_notify_custom()      # 通知手机配网成功
      ↓
  3秒后自动关闭BLE [gs_bind.c:344]

  3.2 AP配网模式

  3.2.1 AP配网启动流程

  gs_bind_start_cfg_mode(GS_BIND_CFG_MODE_AP) [gs_bind.c:481]
      ↓
  __ap_bind_cfg_start() [gs_bind.c:438]
      ↓
  gs_wifi_scan_start() [gs_wifi.c:137]
      ├── cc_hal_wifi_scan_start()       # 扫描周围WiFi
      └── 触发 GS_WIFI_EVENT_SCAN_DONE 事件
      ↓
  __cfg_event_handler() 收到扫描完成事件 [gs_bind.c:282]
      ↓
  __ap_bind_cfg_ap_server_start() [gs_bind.c:418]
      ↓
  gs_wifi_ap_start_setup() [gs_wifi.c:103]
      ├── AP配置:
      │   ├── SSID: "cloudhome-gs-10"
      │   ├── 无密码 (OPEN模式)
      │   ├── IP: 192.168.6.1
      │   ├── 网关: 192.168.6.1
      │   └── 子网掩码: 255.255.255.0
      └── cc_hal_wifi_ap_start_setup()    # 启动AP
      ↓
  captive_portal_start() [captive_portal.c:325]
      ├── 创建TCP服务器 (端口80)        # HTTP服务
      ├── 创建UDP服务器 (端口53)        # DNS服务
      └── 启动 captive_portal_task
      ↓
  cc_hal_tcps_create() [gs_bind.c:434]
      ├── TCP服务器配置:
      │   ├── 端口: 8266                 # 配网数据服务
      │   ├── 最大连接: 1
      │   └── 回调: __tcps_recv_cb
      └── 等待手机连接

  3.2.2 Captive Portal实现原理

  DNS劫持实现：
  captive_portal_tast() [captive_portal.c:114]
      ↓
  监听UDP 53端口（DNS）
      ↓
  手机查询任意域名
      ↓
  拦截DNS查询 [captive_portal.c:159-220]
      ├── 过滤特定查询:
      │   ├── 包含 "conn" 或 "wifi" → 响应
      │   ├── 包含 "huawei" → 华为设备检测
      │   └── 其他 → 通用响应
      ├── 构造DNS响应:
      │   └── 所有域名解析到 192.168.6.1
      └── sendto() 返回响应
      ↓
  手机自动弹出配网页面

  HTTP服务实现：
  监听TCP 80端口
      ↓
  手机HTTP GET请求（检测门户）
      ↓
  根据Host头判断设备类型 [captive_portal.c:246-283]
      ├── 华为设备: "huawei" / "hicloud"
      │   └── 返回: HTTP 204 + 华为特定头
      └── 其他设备:
          └── 返回: HTTP 204 No Content
      ↓
  触发手机弹出配网页面

  3.2.3 AP配网数据交互

  端口8266 TCP服务（配网数据）：

  命令类型1：设置WiFi配置
  // 请求 (cmd_type=1)
  {
      "cmd_type": "1",
      "ssid": "MyWiFi",
      "password": "12345678",
      "token": "device_token"
  }

  // 响应
  {
      "cmd_type": 2,
      "product_key": "...",
      "device_name": "...",
      "status": "0",        // 0=成功, 1=失败
      "ver": "8.0.0.0"
  }

  命令类型3：获取WiFi列表
  // 请求 (cmd_type=3)
  {
      "cmd_type": "3",
      "token": "..."
  }

  // 响应
  {
      "cmd_type": 4,
      "wifi_list": ["WiFi1", "WiFi2", "WiFi3"],
      "status": "0"
  }

  处理流程：
  __tcps_recv_cb() [gs_bind.c:403]
      ↓
  __parse_ap_bind_info() [gs_bind.c:143]
      ↓
  根据cmd_type处理:
      ├── cmd_type=1: 设置WiFi配置 [gs_bind.c:169-215]
      │   ├── 解析ssid/password/token
      │   ├── 保存配置到KVS
      │   ├── 启动500ms定时器
      │   └── 返回设备信息
      └── cmd_type=3: 获取WiFi列表 [gs_bind.c:216-261]
          ├── 读取扫描结果（最多12个）
          ├── 格式化为JSON数组
          └── 返回WiFi列表
      ↓
  500ms后连接WiFi（同BLE流程）

  3.3 WiFi连接流程

  gs_wifi_sta_start_connect() [gs_wifi.c:71]
      ↓
  检查是否有WiFi配置 [gs_wifi.c:74]
      ↓
  设置WiFi模式为STA [gs_wifi.c:79]
      ↓
  cc_hal_wifi_sta_start_connect() [cc_hal_wifi.c]
      ├── 传入SSID和密码
      └── ESP-IDF WiFi驱动连接
      ↓
  等待事件:
      ├── CC_HAL_WIFI_EVENT_STA_CONNECTED [gs_wifi.c:23]
      │   └── 转发 GS_WIFI_EVENT_STA_CONNECTED
      ├── CC_HAL_WIFI_EVENT_STA_GOT_IP [gs_wifi.c:34]
      │   └── 转发 GS_WIFI_EVENT_STA_GOT_IP
      └── CC_HAL_WIFI_EVENT_STA_DISCONNECTED [gs_wifi.c:27]
          └── 转发 GS_WIFI_EVENT_STA_DISCONNECTED

  3.4 MQTT云端绑定

  WiFi获取IP后
      ↓
  gs_mqtt_init() 启动连接
      ↓
  MQTT连接成功 → GS_MQTT_EVENT_CONNECTED
      ↓
  __cfg_event_handler() [gs_bind.c:293]
      ↓
  判断当前是否在配网流程 (g_curr_bind_connect_mode != NULL)
      ↓
  发布绑定消息到云端 [gs_bind.c:308-321]
      ├── Topic: /event/property/post
      ├── 消息1 (绑定确认):
      │   {
      │       "ver": "8.0.0.0",
      │       "act": "0001",     // 绑定动作
      │       "sta": "00",       // 状态码
      │       "token": "...",
      │       "seq_no": "..."
      │   }
      └── 消息2 (版本上报):
          {
              "ver": "8.0.0.0",
              "act": "0003",     // 属性上报
              "type": "03",      // 版本类型
              "data": "8.0.0.0",
              "seq_no": "..."
          }
      ↓
  更新绑定状态 [gs_bind.c:336-337]
      ├── g_bind_status = 1
      └── 保存到KVS → "gs_bind"
      ↓
  发送成功事件 [gs_bind.c:339]
      └── cc_event_post(GS_BIND_EVENT_SUCCESS)
      ↓
  清理配网模式 [gs_bind.c:341-344]
      ├── 注销事件处理器
      ├── 删除超时定时器
      └── 3秒后关闭BLE

  四、配网状态管理

  4.1 持久化存储（KVS）

  项目使用ESP-IDF的NVS（Non-Volatile Storage）作为持久化存储：

  | KVS键名        | 数据类型             | 用途              | 读取位置          | 写入位置          |
  |--------------|------------------|-----------------|---------------|---------------|
  | gs_bind      | uint32_t         | 绑定状态 (0/1)      | gs_bind.c:558 | gs_bind.c:78  |
  | gs_bind_boot | uint32_t         | 启动配网模式标志        | gs_bind.c:561 | gs_bind.c:521 |
  | gs_wifi      | gs_wifi_config_t | WiFi配置（SSID+密码） | gs_wifi.c:148 | gs_wifi.c:53  |
  | MQTT配置       | (未详细分析)          | MQTT服务器/端口/凭证   | gs_mqtt.c     | gs_mqtt.c     |

  4.2 配网状态机

  [未配网] g_bind_status = 0
      │
      ├→ 首次启动 → 等待手动触发
      │
      └→ 长按按钮 → 设置启动标志 → 重启
             │
             ↓
      [配网模式] g_curr_cfg_mode = AP|BLE
             │
             ├→ BLE接收数据 / AP接收数据
             │       ↓
             │   保存WiFi配置
             │       ↓
             │   设置 g_curr_bind_connect_mode
             │       ↓
             ├→ 连接WiFi
             │       ↓
             ├→ 获取IP
             │       ↓
             └→ MQTT连接成功
                     ↓
              [已绑定] g_bind_status = 1
                     │
                     ├→ 保存到KVS
                     ├→ 清除配网模式标志
                     └→ 正常运行
                     │
                     └→ 长按重置 → 回到[未配网]

  4.3 超时保护机制

  gs_bind_start_cfg_mode() [gs_bind.c:496-507]
      ↓
  创建超时定时器: 2分钟
      ↓
  如果2分钟内未完成配网:
      ↓
  __timer_cb_for_bind_timeout() [gs_bind.c:57]
      ├── 停止AP模式
      ├── 停止Captive Portal
      ├── 关闭TCP服务器
      ├── 清除配网模式标志
      ├── 发送失败事件: GS_BIND_EVENT_FAIL
      │   └── 错误码: GS_BIND_ERR_TIMEOUT
      └── 注销事件处理器

  五、配网流程关键时序点

  5.1 完整配网时序（BLE模式）

  T=0s      设备启动 → 进入配网模式
  T=0.5s    BLE初始化完成，开始广播
  T=5s      用户手机发现设备
  T=10s     用户选择WiFi并输入密码
  T=11s     手机通过BLE发送配网数据
  T=11.5s   设备开始连接WiFi
  T=15s     WiFi连接成功，获取IP
  T=16s     MQTT连接云端成功
  T=16.2s   设备发送绑定消息到云端
  T=16.3s   通过BLE通知手机配网成功
  T=19.3s   自动关闭BLE（3秒延时）
  T=20s     配网完成，进入正常运行

  5.2 完整配网时序（AP模式）

  T=0s      设备启动 → 进入配网模式
  T=0.2s    开始WiFi扫描
  T=2s      扫描完成，启动AP模式
  T=2.5s    AP启动完成 (SSID: cloudhome-gs-10)
  T=2.6s    Captive Portal启动 (DNS+HTTP)
  T=2.7s    TCP服务器启动 (端口8266)
  T=5s      用户手机连接AP
  T=6s      DNS劫持生效，弹出配网页面
  T=10s     用户获取WiFi列表（cmd_type=3）
  T=15s     用户选择WiFi并提交（cmd_type=1）
  T=15.5s   设备开始连接WiFi
  T=19s     WiFi连接成功，获取IP
  T=20s     MQTT连接云端成功
  T=20.2s   设备发送绑定消息到云端
  T=21s     配网完成，进入正常运行

  六、配网安全性分析

  6.1 安全机制

  1. Token验证：配网数据必须包含云端颁发的Token (gs_bind.c:103, 217)
  2. BLE配对：使用标准BLE GATT服务，支持配对机制
  3. 数据完整性：UART通信使用CRC-8校验（product.c:48）
  4. 超时保护：配网模式2分钟自动退出
  5. 单次配网：配网成功后清除启动标志，防止重复配网

  6.2 潜在风险点

  1. AP模式无加密：AP使用OPEN模式，WiFi密码明文传输
  2. DNS劫持范围广：劫持所有DNS查询（可能影响合法请求）
  3. HTTP明文传输：端口8266的TCP服务无加密
  4. BLE广播可见：设备名称包含MAC地址，可能泄露设备信息
  5. 无重试限制：WiFi连接失败无自动重试次数限制

  七、配网流程优化建议

  7.1 用户体验优化

  1. LED指示：添加LED指示当前配网状态
  2. 语音提示：通过蜂鸣器提供配网反馈
  3. 超时优化：2分钟可能过短，建议延长至5分钟
  4. 重试机制：WiFi连接失败自动重新进入配网模式

  7.2 安全性增强

  1. AP加密：AP模式使用WPA2-PSK加密
  2. HTTPS：配网数据使用TLS加密传输
  3. 数据签名：配网数据增加HMAC签名验证
  4. BLE绑定：实现BLE配对绑定机制

  7.3 稳定性提升

  1. WiFi扫描优化：增加扫描失败重试
  2. MQTT重连：实现指数退避重连策略
  3. 事件日志：记录配网过程关键事件
  4. 错误上报：配网失败原因通过BLE/AP返回

  八、代码关键路径总结

  8.1 核心函数调用链

  配网启动：
  product_init() 
  → gs_bind_start_cfg_mode() 
  → __ble_bind_cfg_start() / __ap_bind_cfg_start()

  BLE配网：
  __ble_recv_cb() 
  → __parse_ble_bind_info() 
  → gs_wifi_sta_save_config() 
  → __timer_cb_for_wifi_start_connect() 
  → gs_wifi_sta_start_connect()

  AP配网：
  __tcps_recv_cb() 
  → __parse_ap_bind_info() 
  → gs_wifi_sta_save_config() 
  → __timer_cb_for_wifi_start_connect() 
  → gs_wifi_sta_start_connect()

  云端绑定：
  GS_MQTT_EVENT_CONNECTED 
  → __cfg_event_handler() 
  → gs_mqtt_publish() 
  → __save_bind_status()

  8.2 关键文件索引

  | 功能             | 文件路径             | 关键函数/行号                        |
  |----------------|------------------|--------------------------------|
  | 配网模式启动         | gs_bind.c        | gs_bind_start_cfg_mode():481   |
  | BLE配网数据解析      | gs_bind.c        | __parse_ble_bind_info():85     |
  | AP配网数据解析       | gs_bind.c        | __parse_ap_bind_info():143     |
  | WiFi连接         | gs_wifi.c        | gs_wifi_sta_start_connect():71 |
  | BLE初始化         | cc_hal_ble.c     | cc_hal_ble_init():272          |
  | Captive Portal | captive_portal.c | captive_portal_tast():114      |
  | 长按重置           | product.c        | __btn_event_cb1():262          |
  | 主循环            | main.c           | app_main():37                  |

  ---
  总结

  这个项目实现了一个功能完整、架构清晰的双模式配网系统，核心特点：

  1. 灵活性：支持BLE和AP两种配网方式，适应不同应用场景
  2. 完整性：覆盖从设备启动、配网、WiFi连接到云端绑定的完整流程
  3. 健壮性：包含超时保护、状态持久化、错误处理机制
  4. 可扩展性：通过事件系统和模块化设计，便于功能扩展

  配网流程的核心逻辑集中在 gs_bind.c，通过状态机和事件驱动实现了复杂的配网交互，值得深入学习参考。